# archlinux:base as of Oct. 25th, 2021
FROM archlinux@sha256:04d0ec982fe298e0a8fbda48461945c8ed6f0b24dc12492e68b31eac576fc327

RUN pacman -Syy --noconfirm archlinux-keyring
RUN rm -fr /etc/pacman.d/gnupg
RUN pacman-key --init
RUN pacman-key --populate archlinux

# Provide relevant binaries
RUN pacman -Syu --noconfirm 
RUN pacman -S --noconfirm btrfs-progs cryptsetup curl make python python-pip sudo

# Setup Poetry
ENV POETRY_VERSION=1.1.13
RUN curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/$POETRY_VERSION/get-poetry.py | python -
ENV PATH=$PATH:/root/.poetry/bin


# Setup production dependencies
WORKDIR /project
COPY pyproject.toml poetry.lock ./
RUN --mount=type=cache,target=/root/.cache/pip \
    poetry export --dev > requirements.txt \
    && python3 -m pip install -r requirements.txt \
    && rm requirements.txt

# Install project
COPY src/ src/
RUN poetry build \
    && python3 -m pip install dist/*.tar.gz \
    && rm -rf dist/

# Include test files
COPY setup.cfg .

CMD pytest --no-cov .
