# archlinux:latest as of June 14th, 2022
FROM archlinux@sha256:d3bf5ee8ab6200d30fe5366a64b46151f434f6dd0cf8b271297b2e32fc8f6191

RUN pacman -Syy --noconfirm archlinux-keyring
RUN rm -fr /etc/pacman.d/gnupg
RUN pacman-key --init
RUN pacman-key --populate archlinux

# Provide relevant binaries
RUN pacman -Syu --noconfirm
RUN pacman -S --noconfirm btrfs-progs cryptsetup curl make python python-pip restic rsync sudo

# Setup Poetry
ENV POETRY_VERSION=1.1.13
RUN curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/$POETRY_VERSION/get-poetry.py | python3 -
ENV PATH=$PATH:/root/.poetry/bin


# Setup production dependencies
WORKDIR /project
COPY pyproject.toml poetry.lock ./
RUN poetry install

# Install project
COPY src/ src/
RUN poetry install

# Include test files
COPY setup.cfg .

# Create /dev/disk/by-uuid/. It is required by the test suite but not available
# in Docker containers by default.
CMD mkdir -p /dev/disk/by-uuid/ && poetry run pytest --no-cov .
